{% extends 'master.html' %}
{% load staticfiles %}
{% load i18n %}


{% block title %}
  {% trans "Composing email" %} "{{campaign.email_subject}}"
{% endblock %}

{% block content %}

  <div class='container'>
    <div class='row'>
      <div class='col-lg-12'>
        <ol class='breadcrumb'>
          <li>
            <a href='{% url 'campaign-list' %}'>{% trans "Emails" %}</a>
          </li>
          <li>
            <a href='{% url 'campaign-detail' campaign.id %}'>{{campaign.email_subject}}</a>
          </li>
          <li class='active'>{% trans 'Compose' %}</li>
        </ol>
      </div>
    </div>
  </div>

  <a name='content' style='margin-bottom:1rem;display:block'></a>

  <div id='wrap' style='position: fixed; width: 100%; z-index: 100; right: 0; background: #FFF; top: 0; bottom: 0;'>
    <div class='row'>
			<form method='post' novalidate id='email-form'>
				{% csrf_token %}
				<div style='position: fixed; width: 50%; width: calc(50% - 5px); left: 5px; top: 0; bottom: 0;'>
					{% for target, attrs in template.placeholders.items %}
						<div class='form-group'>
							<label for='input-{{forloop.counter0}}'>{{attrs.label|default:"Input"}}:</label>
							<small>(Markdown syntax is ON)
<!-- 										<a href='https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet'>?</a> -->
							</small>
							<textarea
								{% if forloop.counter0 == 0 %} autofocus {% endif %}
								tabindex='{{ forloop.counter }}'
								class='form-control'
								rows='{{attrs.rows|default:"2"}}'
								id='input-{{forloop.counter0}}'
								data-target='{{target}}'
								data-markdown='on'>{{attrs.value|default:""}}</textarea>
						</div>
					{% endfor %}
					<input id="html_email" type='hidden' name='html_email' value='{{campaign.html_email_for_sending}}' />
					<input id="placeholders_value" type='hidden' name='placeholders_value' value='{{campaign.placeholders_value}}' />

					<div class='bottom-bar' style='position: fixed; bottom: 0; left: 0; right: 0; width: 100%; padding: 2rem; border-top: 1px solid #e8e8e8; background: #f9f9f9;    height: 75px; max-height: 75px;'>
						<button class='btn btn-success pull-right' tabindex='{{template.placeholders|length}}'>Next: <strong>Review email</strong> &raquo;</button>
<!--             <button class='btn btn-default pull-right' style='margin-right:5px'>Save draft</button> -->
					</div>
				</div>
			</form>

        <!--  HTML Preview and Text email -->
        <div style='position: fixed; width: 49%; width: calc(50% - 15px);
          z-index: 100; right: 5px; top: 5px; bottom: 75px; text-align: center'>

            <div class="btn-group btn-group-sm" role="group" aria-label="Preview Size">
              <button type="button" data-size='1000x768' class="btn btn-default active btn-resize-preview">Desktop</button>
              <button type="button" data-size='380x500' class="btn btn-default btn-resize-preview">Mobile</button>
<!--               <div class="btn-group" role="group"> -->
<!--                 <button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"> -->
<!--                   Other <span class="caret"></span> -->
<!--                 </button> -->
<!--                 <ul class="dropdown-menu"> -->
<!--                   <li><a href="#">iPhone 7</a></li> -->
<!--                   <li><a href="#">iPhone 6S</a></li> -->
<!--                   <li><a href="#">iPhone 5</a></li> -->
<!--                 </ul> -->
<!--               </div> -->
            </div>
            <br/>
<!--           <form action='{% url "campaign-send-test-email" campaign.pk %}' method='post' class='pull-right' style='width:400px'> -->
<!--             {% csrf_token %} -->
<!--             <input type="hidden" name="redirect-to" value="compose" /> -->
<!--             <div> -->
<!--               <div class="input-group input-group-sm"> -->
<!--                 <span class="input-group-addon" id="sizing-addon1"> -->
<!--                   Send a test email to -->
<!--                 </span> -->
<!--                 <input type="text" name="email" class="form-control" placeholder="your email..." value="{{user.email}}" maxlength=150/> -->
<!--                 <span class="input-group-btn"> -->
<!--                   <button type="submit" class="btn btn-default">Send</button> -->
<!--                 </span> -->
<!--               </div> -->
<!--             </div> -->
<!--           </form> -->

          <iframe
					 id='id_html_email_preview'
					 tabindex="-1"
					 style='max-width: 100%; border: 0; width: 100%; box-shadow: 0 1px 1px #969696; transition: width 0.2s ease-in; height: calc(100% - 44px);margin: 7px auto; border-right: 1px solid #eaeaea;border-top: 1px solid #eaeaea; background: #fff;'
					 {% if campaign.is_composed %}
					 src='{% url "campaign-email-preview" campaign.id %}'>
					 {% else %}
					 src='{% url "template-preview" template.id %}'>
					 {% endif %}
					</iframe>
        </div>

    </div>
  </div>

{% endblock %}


{% block script %}
	<script src='{% static "js/vendor/highlight.min.js" %}'></script>
	<script src='{% static "js/vendor/marked.min.js" %}'></script>
	<script>

		// form2json
		var form2json = function(sel) {
			var els = $(sel);
			var out = {};
			for(var i= 0; i < els.length; i++) {
				out[$(els[i]).attr('data-target')] = els[i].value;
			}
			return JSON.stringify(out);
		};

	  // Marked custom renderer and options
		var customRenderer = new marked.Renderer();
		customRenderer.link = function(href, title, text) {
			return "<a href='" + href + "' target='_blank' title='" + title + "'>" + text + "</a>";
		};
		customRenderer.paragraph = function(text) {
			return '<p>'+text+'</p>';
		};
		var marked_opts = {renderer: customRenderer,
											 gfm: true,
											 smartypants: true,
											 breaks: true,
											 highlight: function (code, lang) {
												 return hljs.highlightAuto(code).value;
											 }};


		var form2preview = function(ev) {

			if (!ev || !ev.currentTarget) {
				return;
			}
			else {
				var curr_el = ev.currentTarget;
			}

			var input = output = this.value || "";

      var previewFrame = document.getElementById('id_html_email_preview');
      var preview =  previewFrame.contentDocument || previewFrame.contentWindow.document;

			var target_el = preview.querySelector(curr_el.getAttribute('data-target'));
			if (!target_el) {
				alert("Sorry, unable to update the email preview at the moment.")
				return;
			}

			if (curr_el.getAttribute('data-markdown') === 'on') {
				output = marked(input, marked_opts);
			}

			target_el.innerHTML = output;

			// Keep html email result in "#html_email"
      var email_keeper = document.getElementById('html_email');
			email_keeper.value = serializer.serializeToString(preview);

			// Save placeholders value
      var ph_keeper = document.getElementById('placeholders_value');
			ph_keeper.value = form2json('form#email-form textarea[data-target]');

		};

		// On DOM ready
		$(function() {

			// Global serializer used for reading iframe HTML content
			serializer = new XMLSerializer();

			// Cache compose email form element
			var $email_form = $('form#email-form');

			// Prevent return key form submission
			$email_form.on('keypress', 'input, select', function(ev) {
				return ev.keyCode != 13;
			});

			// Listening on form input elements and inject in preview frame
			$email_form.on('input', 'textarea', form2preview);

			// Resize HTML Preview buttons
			$('.btn-resize-preview').on('click', function (ev) {
				$('.btn-resize-preview').toggleClass('active');
				var size = $(this).data('size').split('x');
				$('#id_html_email_preview').css('width', size[0]+'px')
				$(this).blur()
			});

		});

	</script>
{% endblock %}
